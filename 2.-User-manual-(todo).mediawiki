November 2019, version 4.0.0

=Introduction=

SortMeRNA is a local sequence alignment tool for filtering, mapping and OTU clustering. The core algorithm is based on approximate seeds and allows for fast and sensitive analyses of NGS reads. The main application of SortMeRNA is filtering rRNA from metatranscriptomic data. Additional applications include OTU-picking and taxonomy assignation available through QIIME v1.9+ (http://qiime.org). SortMeRNA takes as input one or two (paired) reads file(s) (fasta/fasta.gz/fastq/fastq.gz), and one or multiple rRNA database file(s), and sorts apart aligned and rejected reads into two files. SortMeRNA works with Illumina, 454, Ion Torrent and PacBio data, and can produce SAM and BLAST-like alignments.

[[https://github.com/biocore/sortmerna/blob/issue_136_paired_reads/docs/web/img/smr_3_processing_pipeline.svg | Processing pipeline]] 
 
Figure 1. Processing pipeline

=Databases=
{|
| representative database          || %id || <nowiki>#</nowiki> seq (clustered) || origin  || <nowiki>#</nowiki> seq (original)
|-
| silva-bac-16s-id90    || 90  || 12798  || SILVA SSU Ref NR v.119 || 464618
|-
| silva-arc-16s-id95	|| 95  || 3193  || SILVA SSU Ref NR v.119 || 18797
|-
| silva-euk-18s-id95    || 95  || 7348  || SILVA SSU Ref NR v.119 || 51553
|-
| silva-bac-23s-id98    || 98  || 4488  || SILVA LSU Ref v.119    || 43822
|-
| silva-arc-23s-id98    || 98  || 251   || SILVA LSU Ref v.119 || 629
|-
| silva-euk-28s-id98    || 98  || 4935  || SILVA LSU Ref v.119 || 13095
|-
| rfam-5s-id98	98      || 98  || 59513 || RFAM || 116760
|-
| rfam-5.8s-id98	|| 98  || 13034 || RFAM ||225185
|}

HMMER 3.1b1 and SumaClust v1.0.00 were used to reduce the size of the original databases to the similarity listed in column 2 (%id) of the table above (see /sortmerna/rRNA databases/README.txt for a list of complete steps).

These representative databases were specically made for fast ltering of rRNA. Approximately the same number of rRNA will be ltered using silva-bac-16s-id90 (12802 rRNA) as using Greengenes 97% (99322 rRNA), but the former will run signicantly faster.

id %: members of the cluster must have identity at least this % id with the representative sequence.

Remark: The user must first index the fasta database by using the command indexdb and then filter/map reads against the database using the command sortmerna. 

=Usage=

Note that unlike the previous releases, Sortmerna 4 has a single executable <code>sortmerna</code>. There is no more a separate <code>indexdb</code> command. The user still have a control over the indexing using the <code>sortmerna</code> indexing options.

==Options==
{|
| Option || argument || description || default
|-
| -ref || PATH || Reference file (FASTA) absolute or relative path.<br/> Use mutliple times, once per a reference file
|-
| -reads || PATH || Raw reads file (FASTA/FASTQ/FASTA.GZ/FASTQ.GZ).<br/>Use twice for files with paired reads
|-
| [ -workdir ] || PATH || Working directory for storing the Reference index, Key-value database, Output || USRDIR/sortmerna/run/
|-
| [ -fastx ] || Boolean || Output aligned reads into FASTA/FASTQ file
|-
| [ -SQ ] || Boolean || Add SQ tags to the SAM file ||
|-
| [ -blast ] || String
|  output alignments in various Blast-like formats
    '0'                    - pairwise
    '1'                    - tabular(Blast - m 8 format)
    '1 cigar'              - tabular + column for CIGAR
    '1 cigar qcov'         - tabular + columns for CIGAR
                             and query coverage
    '1 cigar qcov qstrand' - tabular + columns for CIGAR,
                             query coverage and strand
|-
| [ -other ] || Boolean || Create Non-aligned reads output file.<br/>Must be used with 'fastx' || False
|-
| [ -num_alignments ] || Int || Positive integer (>=0).<br/>Report first INT alignments per read reaching E-value<br/>If Int = 0, all alignments will be output ||
|-
| [ -best ] || || ||
|-
| [ -min_lis ] || || ||
|-
| [ -print_all_reads ] || || ||
|-
| [ -paired_in ] || || ||
|-
| [ -paired_out ] || || ||
|-
| [ -match ] || || ||
|-
| [ -mismatch ] || || ||
|-
| [ -gap_open ] || || ||
|-
| [ -gap_ext ] || || ||
|-
| [ -a ] || || ||
|-
| [ -e ] || || ||
|-
| [ -F ] || || ||
|-
| [ -N ] || || ||
|-
| [ -R ] || || ||
|-
|  [ -id ] || || ||
|-
| [ -coverage ] || || ||
|}

List the version
  sortmerna --version

List the help:
  sortmerna -h

==Choosing parameters for filtering and read mapping==

In SortMeRNA users have the option to output sequence alignments for their matching rRNA reads in the SAM or BLAST-like formats. Depending on the desired quality of alignments, different parameters must be set. Table 1 presents a guide to setting parameters for most use cases. In all cases, output alignments are always guaranteed to reach the threshold E-value score (default E-value=1). An E-value of 1 signifies that one random alignment is expected for aligning all reads against the reference database. The E-value in SortMeRNA is computed for the entire search space, not per read. 

{| class="wikitable"
| Option                     || Speed  || Description
|-
| rowspan="3" | --num-alignments INT
| Very fast for INT = 1 
| Output the first alignment passing E-value threshold (best choice if only filtering is needed)
|-
| Speed decreases for higher value INT || Higher INT signifies more alignments will be made & output
|-
| Very slow for INT = 0
| All alignments reaching the E-value threshold are reported (this option is not suggested for high similarity rRNA databases, due to many possible alignments per read causing a very large file output)
|-
| rowspan="3"| --best INT
| Fast for INT = 1
| Only one high-candidate reference sequence will be searched for alignments (determined heuristically using a Longest Increasing Sub-sequence of seed matches). The single best alignment of those will be reported
|-
| Speed decreases for higher value INT
| Higher INT signies more alignments will be made, though only the best one will be reported
|-
| Very slow for INT = 0
| All high-candidate reference sequences will be searched for alignments, though only the best one will be reported
|}

Table 1: SortMeRNA alignment parameter guide

===Example: multiple databases and the fastest alignment option===
  sortmerna -ref $SMR_HOME/data/silva-bac-16s-database-id85.fasta \
  -ref $SMR_HOME/data/silva-arc-16s-database-id95.fasta \
  -reads $SMR_HOME/data/set2_environmental_study_550_amplicon.fasta \
  -sam -fastx -blast 1 -num_alignments 1 -v

===Filtering paired-end reads===

If two reads files are provided ( using '-reads' twice) as input to Sortmerna e.g.
  sortmerna -ref Ref_1 -reads File_1 -reads Rile_2 ...
the reads files are considered Paired.

The following situations are possible for paired reads:
# A_0: Neither of the two paired reads is aligned
# A_1: Only a single out of two paired reads is aligned (i.e. alignment score is above the given threshold)
# A_2: Both paired reads are aligned

A_0 and A_2 are straightforward: A_0 never generates any output, and A_2 always writes the pairs into 'aligned.fasta' file.

Output generated in A_1 case can be controlled using the following options:

* fastx
* other
* paired_in
* paired_out

{|
| fastx || other || paired_in || paired_out || Num entries written into aligned.fasta per pair || other.fasta
|-
|   true   || false || false || false || 1 || 0
|-
|   true   || false || true || false || 2 || 0
|-
|   true   || false || 0 || 1 || 0 || 0
|-
|   true   || true || 1 || 0 || 2 || 0
|-
|   true   || true || 0 || 1 || 0 || 2
|}
When writing aligned and non-aligned reads to FASTA/Q files, sometimes the situation arises where one of the paired-end reads aligns and the other one doesn't. Since SortMeRNA looks at each read individually, by default the reads will be split into two separate files. That is, the read that aligned will go into the 'aligned.fasta' and the pair that didn't align will go into the 'other.fasta'.

This situation would result in the splitting of some paired reads in the output files and not optimal for users who require paired order of the reads for downstream analyses.
For users who wish to keep the order of their paired-ended reads, two options are available. If one read aligns and the other one not then,

    (1) --paired_in will put both reads into the 'aligned.fasta' file
    (2) --paired_out will put both reads into the 'other.fasta' file

The first option, --paired_in is optimal for users who want all reads in the --other file to be non-rRNA. However, there are small chances that reads which are non-rRNA will also be put into the --aligned file.

The second option, --paired_out is optimal for users that want only rRNA reads in the --aligned file. However, there are small chances that reads which are rRNA will also be put into the --other file.

If neither of these two options is added to the sortmerna command, then aligned and non-aligned reads will be properly output to the --aligned and --other files, possibly breaking the order for a set of paired reads between two output files.

It's important to note that regardless of the options used, the --log file will always report the true number of reads classied as rRNA (not the number of reads in the --aligned file). 

===Mapping reads for classification===

==OTU-picking==

SortMeRNA is implemented in QIIME's closed-reference and open-reference OTU-picking workflows. The readers are referred to QIIME's tutorials for an in-depth discussion of these methods http://qiime.org/tutorials/otu_picking.html. 

==Advanced==

=Help=

=Citation=

If you use SortMeRNA please cite,

Kopylova E., Noe L. and Touzet H., "SortMeRNA: Fast and accurate filtering of ribosomal RNAs in metatranscriptomic data", Bioinformatics (2012), doi: 10.1093/bioinformatics/bts611.

Copyright (C) 2016-2019 Clarity Genomics BVBA
Turnhoutseweg 30, 2340 Beerse, Belgium
http://www.clarity-genomics.com

Copyright (C) 2014-2016 Knight Lab
Department of Pediatrics, UCSD School of Medicine, La Jolla, California, USA
https://knightlab.colorado.edu

Copyright (C) 2012-2014 Bonsai Bioinformatics Research Group
(LIFL - Université Lille 1), CNRS UMR 8022, INRIA Nord-Europe, France
http://bioinfo.lifl.fr/RNA/sortmerna/
